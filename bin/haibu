#!/usr/local/bin/node

var clip = require('clip');
var winston = require('winston');
var colors = require('colors');
var haibu = require('../');
var app = new clip();
var fs = require('fs');

app.config('.haibuconf',{
  flags: ['c', 'conf'],
  defaults: {
    port: 9002,
    host: '127.0.0.1'
  }
});

app.flag(['s','silent'],function(req,res,next) {
  res.remove(res.transports.Console);
})

app.use(function(req,res,next){
  res.info('Using config file '+req.config.store.file.magenta);

  try {
    var deploymentscript = req.config.get('f') || req.config.get('file') || 'package.json';
    req.app = JSON.parse(fs.readFileSync(deploymentscript));
    res.info('Deployment script is ' + fs.realpathSync(deploymentscript).magenta);
  } catch(e) {
    res.warn('No deployment script was detected');
    req.app = {};
  }

  var clientsettings = {
    host: req.config.get('a') || req.config.get('address'),
    port: req.config.get('p') || req.config.get('port')
  };

  res.info('haibu-server located at '+(clientsettings.host+':'+clientsettings.port).magenta);
  req.client = new haibu.drone.Client(clientsettings);

  next();
});
require('../lib/haibu/cli/config')(app);
require('../lib/haibu/cli/apps')(app);

app.usage(function usage(req,res) {
  res.info('');
  res.info('haibu'.bold.underline);
  res.info('  CLI interface to manage a Haibu server.');
  res.info('  Please refer to documentation of commands using `-h` or `--help`.');
  res.info('');
  res.info('commands'.bold);
  res.info('  haibu apps'.green);
  res.info('  haibu config'.green);
  res.info('');
  res.info('flags'.bold);
  res.info('  -s --silent                Do not log to console');
  res.info('');
});

app.run();
